<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <script src="https://unpkg.com/maplibre-gl@5.9.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@5.9.0/dist/maplibre-gl.css" rel="stylesheet"/>
    <script type="text/javascript" src="../js/qrcode.js"></script>
    <link rel="stylesheet" href="../css/tracemap.css" media="all" onload="this.media='all'">
    <title>NextTrace traceMap (MapLibre)</title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        .maplibregl-popup-content {
            padding: 10px;
            max-width: 300px;
        }
        .maplibregl-popup-content h3 {
            margin: 0 0 10px 0;
            color: purple;
        }
        .marker {
            background-color: #e74c3c;
            border: 2px solid white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        .marker:hover {
            width: 28px;
            height: 28px;
            margin-left: -2px;
            margin-top: -2px;
            font-size: 14px;
        }
        .table-container {
            position: absolute;
            left: 10px;
            z-index: 2;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: block;
        }
        .table-container table {
            border-collapse: collapse;
            width: 100%;
            font-size: 13px;
        }
        .table-container th {
            background: purple;
            color: white;
            padding: 8px;
            text-align: left;
            position: sticky;
            top: 0;
        }
        .table-container td {
            padding: 6px 8px;
            border-bottom: 1px solid #ddd;
        }
        .table-container tr:hover {
            background: #f5f5f5;
        }
        .table-container > div {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }
        .qrcode-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 2;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
        }
        .context-menu {
            position: absolute;
            display: none;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            min-width: 150px;
        }
        .context-menu-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .context-menu-item:last-child {
            border-bottom: none;
        }
        .context-menu-item:hover {
            background: #f0f0f0;
        }
        #bt {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1;
            display: none;
        }
        #bt button {
            display: block;
            margin-bottom: 5px;
            padding: 8px 15px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        #bt button:hover {
            background: #f0f0f0;
        }
    </style>
</head>
<body>
<div id="bt"></div>
<div class="table-container" id="myTable">
    <table>
        <tr>
            <th>TTL</th>
            <th>IP</th>
            <th>Hostname</th>
            <th>RTT</th>
            <th>ASN</th>
            <th>Geography</th>
        </tr>
        <tbody id="table-body"></tbody>
    </table>
    <div>Tips: 右键点击地图显示菜单</div>
</div>
<div class="qrcode-container">
    <div id="qrcode"></div>
</div>
<div class="context-menu" id="contextMenu">
    <div class="context-menu-item" onclick="map.zoomIn(); hideContextMenu()">放大一级</div>
    <div class="context-menu-item" onclick="map.zoomOut(); hideContextMenu()">缩小一级</div>
    <div class="context-menu-item" onclick="toggle3D(); hideContextMenu()">3D视角</div>
    <div class="context-menu-item" onclick="hideTable(); hideContextMenu()">路由表</div>
    <div class="context-menu-item" onclick="hideQrcode(); hideContextMenu()">QrCode</div>
    <div class="context-menu-item" onclick="startAnimation(); hideContextMenu()">播放路径动画</div>
</div>
<div id="map"></div>
</body>
</html>
<script type="text/javascript">
    // Initialize variables
    let pathCoordinates = [];
    let markersData = []; // Store marker data before map loads
    let markers = [];
    let is3D = false;
    let initialCenter = [0, 0];
    let initialZoom = 2;
    let currentProjection = 'mercator'; // Track current projection
    let hopCounter = 0; // Track hop number for markers

    // Compatibility wrapper for Baidu Maps API
    const path = []; // Dummy path array for compatibility

    // Mock BMapGL.Point for compatibility
    if (typeof BMapGL === 'undefined') {
        window.BMapGL = {
            Point: function(lng, lat) {
                return { lng: lng, lat: lat };
            }
        };
    }

    // Temporary map object for compatibility with Python-injected code
    let map = {
        centerAndZoom: function(point, zoom) {
            initialCenter = [point.lng || point[0], point.lat || point[1]];
            // by default BMapGL is too large for maplibre.
            initialZoom = Math.max(zoom - 2, 0);
        }
    };

    function AddPathPoint(pathObj, lat, lon) {
        // Note: pathObj parameter is for compatibility with Baidu Maps version
        
        // Handle antimeridian crossing for shortest path
        if (pathCoordinates.length > 0) {
            const prevLng = pathCoordinates[pathCoordinates.length - 1][0];
            const lngDiff = lon - prevLng;
            
            // If the difference is >= 180, we should go the other way
            if (lngDiff >= 180) {
                lon -= 360;
            } else if (lngDiff < -180) {
                lon += 360;
            }
        }
        
        pathCoordinates.push([lon, lat]);
    }

    function AddPoint(mapObj, name, description, lat, lon) {
        // Store marker data to be added after map loads
        hopCounter++;
        markersData.push({ name, description, lat, lon, hopNumber: hopCounter });
    }

    // Python will inject data here
    // Python 写入部分开始

    %_REPLACE_CONTENT0_%

    // Python 写入部分结束

    // Initialize the map with correct initial view
    map = new maplibregl.Map({
        container: 'map',
        style: 'https://tiles.openfreemap.org/styles/liberty',
        center: initialCenter,
        zoom: initialZoom,
        pitch: 0,
        bearing: 0
    });

    map.addControl(new maplibregl.NavigationControl());
    map.addControl(new maplibregl.FullscreenControl());

    // Wait for the map to load
    map.on('load', function() {
        // Add all markers
        markersData.forEach(data => {
            const el = document.createElement('div');
            el.className = 'marker';
            el.textContent = data.hopNumber; // Display hop number
            
            const popup = new maplibregl.Popup({ offset: 25 }).setHTML(
                `<h3>${data.name}</h3><div style="max-height: 200px; overflow-y: auto;">${data.description}</div>`
            );
            
            const marker = new maplibregl.Marker({
                    element: el,
                })
                .setLngLat([data.lon, data.lat])
                .setPopup(popup)
                .addTo(map);
            
            markers.push(marker);
        });

        // Add the route line
        map.addSource('route', {
            'type': 'geojson',
            'data': {
                'type': 'Feature',
                'properties': {},
                'geometry': {
                    'type': 'LineString',
                    'coordinates': pathCoordinates
                }
            }
        });

        map.addLayer({
            'id': 'route',
            'type': 'line',
            'source': 'route',
            'layout': {
                'line-join': 'round',
                'line-cap': 'round'
            },
            'paint': {
                'line-color': '#9b59b6',
                'line-width': 3,
                'line-opacity': 0.8
            }
        });

        // Add animated layer for animation
        map.addSource('animation-point', {
            'type': 'geojson',
            'data': {
                'type': 'FeatureCollection',
                'features': []
            }
        });

        map.addLayer({
            'id': 'animation-point',
            'type': 'circle',
            'source': 'animation-point',
            'paint': {
                'circle-radius': 8,
                'circle-color': '#FFA500',
                'circle-stroke-width': 2,
                'circle-stroke-color': '#ffffff'
            }
        });
    });

    function toggle3D() {
        if (currentProjection === 'mercator') {
            // Switch to globe projection
            map.setProjection({
                type: 'globe'
            });
            currentProjection = 'globe';
            is3D = true;
        } else {
            // Switch back to mercator projection
            map.setProjection({
                type: 'mercator'
            });
            currentProjection = 'mercator';
            is3D = false;
        }
    }

    function generateTable() {
        const data = %_REPLACE_CONTENT1_%;;

        const tableBody = document.getElementById("table-body");
        data.forEach(item => {
            const row = document.createElement("tr");
            item.forEach(col => {
                const cell = document.createElement("td");
                cell.innerHTML = col;
                row.appendChild(cell);
            });
            tableBody.appendChild(row);
        });
    }

    function hideTable() {
        const t = document.getElementById("myTable");
        const currentDisplay = window.getComputedStyle(t).display;
        if (currentDisplay === "none") {
            t.style.display = "block";
        } else {
            t.style.display = "none";
        }
    }

    function generateQrcode() {
        new QRCode(document.getElementById("qrcode"), window.location.href);
    }

    function hideQrcode() {
        const q = document.getElementsByClassName("qrcode-container")[0];
        const currentDisplay = window.getComputedStyle(q).display;
        if (currentDisplay === "none") {
            q.style.display = "block";
        } else {
            q.style.display = "none";
        }
    }

    let animationRunning = false;
    let animationFrame = null;

    function startAnimation() {
        if (animationRunning) return;
        if (pathCoordinates.length < 2) return;

        animationRunning = true;
        let counter = 0;
        const totalSteps = pathCoordinates.length * 20; // Interpolate between points
        
        function animate() {
            if (counter >= totalSteps) {
                // Remove animation point
                map.getSource('animation-point').setData({
                    'type': 'FeatureCollection',
                    'features': []
                });
                animationRunning = false;
                return;
            }

            const progress = counter / totalSteps;
            const segmentLength = 1 / (pathCoordinates.length - 1);
            const segmentIndex = Math.floor(progress / segmentLength);
            const segmentProgress = (progress % segmentLength) / segmentLength;

            if (segmentIndex < pathCoordinates.length - 1) {
                const start = pathCoordinates[segmentIndex];
                const end = pathCoordinates[segmentIndex + 1];
                
                const lng = start[0] + (end[0] - start[0]) * segmentProgress;
                const lat = start[1] + (end[1] - start[1]) * segmentProgress;

                map.getSource('animation-point').setData({
                    'type': 'FeatureCollection',
                    'features': [{
                        'type': 'Feature',
                        'geometry': {
                            'type': 'Point',
                            'coordinates': [lng, lat]
                        }
                    }]
                });

                // Move camera to follow the point
                map.easeTo({
                    center: [lng, lat],
                    duration: 50
                });
            }

            counter++;
            animationFrame = requestAnimationFrame(animate);
        }

        animate();
    }

    // Context menu
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        const menu = document.getElementById('contextMenu');
        menu.style.display = 'block';
        menu.style.left = e.pageX + 'px';
        menu.style.top = e.pageY + 'px';
    });

    document.addEventListener('click', function(e) {
        if (!e.target.closest('.context-menu')) {
            hideContextMenu();
        }
    });

    function hideContextMenu() {
        document.getElementById('contextMenu').style.display = 'none';
    }

    // Initialize
    generateTable();
    generateQrcode();

    // Mobile device detection
    if (/Mobi|Android|iPhone/i.test(navigator.userAgent)) {
        // Show buttons for mobile devices instead of context menu
        const bt = document.getElementById("bt");
        bt.style.display = "block";
        bt.innerHTML = "<button onclick='toggle3D()'>3D视角</button>";
        bt.innerHTML += "<button onclick='hideTable()'>路由表</button>";
        bt.innerHTML += "<button onclick='hideQrcode()'>QrCode</button>";
        bt.innerHTML += "<button onclick='startAnimation()'>播放动画</button>";
        
        // Update tip text for mobile
        const tipDiv = document.querySelector(".table-container > div");
        if (tipDiv) {
            tipDiv.textContent = "Tips: 通过左上角按钮切换显示选项";
        }
        
        // Hide table by default on mobile devices
        hideTable();
    }

</script>

